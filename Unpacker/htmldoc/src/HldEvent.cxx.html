<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!--                                             -->
<!-- Author: ROOT team (rootdev@pcroot.cern.ch)  -->
<!--                                             -->
<!--   Date: Mon Dec 15 12:32:45 2008            -->
<!--                                             -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<title>HldEvent - source file</title>
<meta name="rating" content="General" />
<meta name="objecttype" content="Manual" />
<meta name="keywords" content="software development, oo, object oriented, unix, x11, windows, c++, html, rene brun, fons rademakers, cern" />
<meta name="description" content="ROOT - An Object Oriented Framework For Large Scale Data Analysis." />
<link rel="stylesheet" type="text/css" href="../ROOT.css" id="ROOTstyle" />
<script type="text/javascript" src="../ROOT.js"></script>
</head>
<body  onload="javascript:SetValuesFromCookie();">
<pre class="code">
<span class="comment">// File: hldevent_wk.cc</span>
<span class="comment">//</span>
<span class="comment">// Author: Wojciech Krzemien &lt;wojciech.krzemien@if.uj.edu.pl&gt; 12.10.06</span>
<span class="comment">// Modified:</span>
<span class="comment">// </span>

<span class="cpp">#include "<a href="../hldevent_wk.h">hldevent_wk.h</a>"</span>
<span class="cpp">#include "TError.h"</span>
<span class="cpp">#include &lt;iostream&gt;</span>
<span class="cpp">#include &lt;iomanip&gt; </span>
<span class="cpp">#include &lt;unistd.h&gt;</span>

<span class="comment">//______________________________________________________________________________</span>
<span class="comment">//   <a href="../HldEvent.html">HldEvent</a></span>
<span class="comment">//</span>
<span class="comment">////////////////////////////////////////////////////////////////////////////////</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> std;

ClassImp(<a href="../HldEvent.html">HldEvent</a>) 

<span class="keyword">const</span> <a href="../ListOfTypes.html#Int_t">Int_t</a> kMaxSubEvtId=999;

<span class="comment">//______________________________________________________________________________</span>
<a name="p9hbd"></a><a href="../ListOfTypes.html#Bool_t">Bool_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:setFile" title="Bool_t HldEvent::setFile(const Text_t* name)">setFile</a>(<span class="keyword">const</span> <a href="../ListOfTypes.html#Text_t">Text_t</a> *name)
{
    <span class="keyword">if</span> (access(name,F_OK)!=0)
    {
	<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::setFile()"</span>,<span class="string">"Error during access of file %s !"</span>,name);
	exit(EXIT_FAILURE);
    }

    stat(name,&amp;<a href="../HldEvent.html#HldEvent:status" title="stat HldEvent::status">status</a>);
    <span class="keyword">if</span>(<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)
    {
	((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;open(name);
	<span class="keyword">if</span>(!((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;is_open())
	{
	    <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::setFile()"</span>,<span class="string">"Error during opening file %s !"</span>,name);
	    exit(EXIT_FAILURE);
	}
	<span class="keyword">if</span>(!((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;good())
	{
	    <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::setFile()"</span>,<span class="string">"Error flags discovered in stream of file %s !"</span>,name);
	    exit(EXIT_FAILURE);
	}
	
    }
    <span class="keyword">else</span>
    {
	<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>=<span class="keyword">new</span> std::<a href="../ListOfTypes.html#ifstream">ifstream</a>(name);
	<span class="keyword">if</span>(!((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;is_open())
	{
	    <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::setFile()"</span>,<span class="string">"Error during opening file %s !"</span>,name);
	    exit(EXIT_FAILURE);
	}
	<span class="keyword">if</span>(!((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;good())
	{
	    <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::setFile()"</span>,<span class="string">"Error flags discovered in stream of file %s !"</span>,name);
	    exit(EXIT_FAILURE);
	}
    }
    <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kTRUE</a>;
}

<span class="comment">//______________________________________________________________________________</span>
<a name="CdK8xD"></a><a href="../ListOfTypes.html#Bool_t">Bool_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:read" title="Bool_t HldEvent::read()">read</a>() {
  <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>) {
    <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>-&gt;eof()) {
      <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
    }
    <span class="keyword">if</span>(!((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;good())
    {
	<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::read()"</span>,<span class="string">"Error flags discovered in input stream before read!"</span>);
	exit(1);
    }

    <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:pData" title="UInt4* HldEvent::pData">pData</a>) {
      <span class="keyword">delete</span>[] <a href="../HldEvent.html#HldEvent:pData" title="UInt4* HldEvent::pData">pData</a>;
      <a href="../HldEvent.html#HldEvent:pData" title="UInt4* HldEvent::pData">pData</a> = 0;
    }
    <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>-&gt;<a href="../HldEvent.html#HldEvent:read" title="Bool_t HldEvent::read()">read</a>((<span class="keyword">char</span> *)(<a href="../HldEvent.html#HldEvent:pHdr" title="UInt4* HldEvent::pHdr">pHdr</a>), <a href="../HldEvent.html#HldEvent:getHdrSize" title="size_t HldEvent::getHdrSize()">getHdrSize</a>())) {
      <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:isSwapped" title="Bool_t HldEvent::isSwapped()">isSwapped</a>()) <a href="../HldEvent.html#HldEvent:swapHdr" title="void HldEvent::swapHdr()">swapHdr</a>();
      <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:getSize" title="UInt4 HldEvent::getSize()">getSize</a>() &gt; <a href="../HldEvent.html#HldEvent:getHdrSize" title="size_t HldEvent::getHdrSize()">getHdrSize</a>()) {

	<span class="cpp">#warning "Hardcoded maximum event size is 1000000"</span>
	<span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:getDataLen" title="size_t HldEvent::getDataLen()">getDataLen</a>() &gt; 1000000) <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
<span class="comment">/*wk: co z tym dalej
	<a href="../ListOfTypes.html#size_t">size_t</a> filesize    =(<a href="../ListOfTypes.html#size_t">size_t</a>)<a href="../HldEvent.html#HldEvent:status" title="stat HldEvent::status">status</a>.st_size;
	<a href="../ListOfTypes.html#size_t">size_t</a> expectedsize=((<a href="../ListOfTypes.html#size_t">size_t</a>)((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;tellg())+<a href="../HldEvent.html#HldEvent:getPaddedSize" title="size_t HldEvent::getPaddedSize()">getPaddedSize</a>();
	if(expectedsize&gt;filesize)
	{
	    <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::read()"</span>,
		  <span class="string">"Could not read enough bytes from file! \n File pointer + padded Size = %i bytes, file size = %i bytes !"</span>,
		  expectedsize , filesize);
	    return <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
	}
*/</span>
	<a href="../HldEvent.html#HldEvent:pData" title="UInt4* HldEvent::pData">pData</a> = <span class="keyword">new</span> <a href="../ListOfTypes.html#UInt4">UInt4</a>[<a href="../HldEvent.html#HldEvent:getDataLen" title="size_t HldEvent::getDataLen()">getDataLen</a>()];
	<span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>-&gt;<a href="../HldEvent.html#HldEvent:read" title="Bool_t HldEvent::read()">read</a>((<span class="keyword">char</span>*)(<a href="../HldEvent.html#HldEvent:pData" title="UInt4* HldEvent::pData">pData</a>), <a href="../HldEvent.html#HldEvent:getDataSize" title="size_t HldEvent::getDataSize()">getDataSize</a>()))
	  <a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>-&gt;ignore(<a href="../HldEvent.html#HldEvent:getPaddedSize" title="size_t HldEvent::getPaddedSize()">getPaddedSize</a>() - <a href="../HldEvent.html#HldEvent:getSize" title="UInt4 HldEvent::getSize()">getSize</a>());
      }
    }

    <span class="keyword">if</span>(!((<a href="../ListOfTypes.html#ifstream">ifstream</a>*)<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>)-&gt;good())
    {
	<span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:file" title="istream* HldEvent::file">file</a>-&gt;eof())
	{
	    <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"HldEvent::read()"</span>,<span class="string">"Error flags discovered in input stream after read!"</span>);
	}
	<span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
    } <span class="keyword">else</span> {<span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kTRUE</a>;}

  } 
  <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
}

<span class="comment">//______________________________________________________________________________</span>
<a name="j5SZkC"></a><a href="../ListOfTypes.html#Bool_t">Bool_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:readSubEvt" title="Bool_t HldEvent::readSubEvt(size_t i)">readSubEvt</a>(<a href="../ListOfTypes.html#size_t">size_t</a> i) {
  <a href="../ListOfTypes.html#UInt4">UInt4</a>* p;
  <span class="keyword">if</span> (i)
    p = <a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i-1].<a href="../HldEvent.html#HldEvent:getPaddedEnd" title="UInt4* HldEvent::getPaddedEnd()">getPaddedEnd</a>();
   <span class="keyword">else</span>
    p = <a href="../HldEvent.html#HldEvent:pData" title="UInt4* HldEvent::pData">pData</a>;
  <span class="keyword">if</span> (p &lt; <a href="../HldEvent.html#HldEvent:getPaddedEnd" title="UInt4* HldEvent::getPaddedEnd()">getPaddedEnd</a>())
    <a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i] = <a href="../HldSubEvent.html">HldSubEvent</a>(p);
  <span class="keyword">else</span>
    <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
  <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kTRUE</a>;
}
  
<span class="comment">//______________________________________________________________________________</span>
<a name="hVye2B"></a><a href="../ListOfTypes.html#Bool_t">Bool_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:execute" title="Bool_t HldEvent::execute()">execute</a>() {
 <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:read" title="Bool_t HldEvent::read()">read</a>()) {
    <span class="keyword">for</span> (<a href="../ListOfTypes.html#size_t">size_t</a> idx = 0; idx &lt; <a href="../HldEvent.html#HldEvent:lastSubEvtIdx" title="size_t HldEvent::lastSubEvtIdx">lastSubEvtIdx</a>; idx++) *<a href="../HldEvent.html#HldEvent:subEvtTable" title="HldEvent::SubEvtTable HldEvent::subEvtTable">subEvtTable</a>[idx].p = 0;
    <span class="keyword">for</span> (<a href="../ListOfTypes.html#size_t">size_t</a> i = 0; i &lt; <a href="../HldEvent.html#HldEvent:maxSubEvts" title="const size_t HldEvent::maxSubEvts">maxSubEvts</a> &amp;&amp; <a href="../HldEvent.html#HldEvent:readSubEvt" title="Bool_t HldEvent::readSubEvt(size_t i)">readSubEvt</a>(i); i++) { <span class="comment">// loop subevts</span>
      <a href="../ListOfTypes.html#Bool_t">Bool_t</a> unpacked=<a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
      <span class="keyword">for</span> (<a href="../ListOfTypes.html#size_t">size_t</a> idx = 0; idx &lt; <a href="../HldEvent.html#HldEvent:lastSubEvtIdx" title="size_t HldEvent::lastSubEvtIdx">lastSubEvtIdx</a>; idx++) { <span class="comment">// loop unpackers</span>
        <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i].<a href="../HldEvent.html#HldEvent:getId" title="UInt4 HldEvent::getId()">getId</a>() == <a href="../HldEvent.html#HldEvent:subEvtTable" title="HldEvent::SubEvtTable HldEvent::subEvtTable">subEvtTable</a>[idx].id) {
          <a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i].swapData();
          *<a href="../HldEvent.html#HldEvent:subEvtTable" title="HldEvent::SubEvtTable HldEvent::subEvtTable">subEvtTable</a>[idx].p = <a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a> + i;
<span class="comment">//        <a href="../ListOfTypes.html#ostream">cout</a> &lt;&lt; <span class="string">"pass a pointer to subevt to its unpacker"</span> &lt;&lt; endl;</span>
          unpacked=<a href="../ListOfTypes.html#Bool_t">kTRUE</a>;
        }
      }
      <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:isWritable" title="Bool_t HldEvent::isWritable">isWritable</a> &amp;&amp; !unpacked ){
                   <span class="comment">// to assure that the swapData() can work</span>
          <span class="keyword">if</span>(((<a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i].getWordSize())==1) || ((<a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i].getWordSize())==2) || ((<a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i].getWordSize())==4) ){ 
			<a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i].swapData();
          }
          <span class="keyword">else</span>
            <a href="http://root.cern.ch/root/html/TObject.html#TObject:Warning" title="void TObject::Warning(const char* method,const char* msgfmt)">Warning</a>(<span class="string">"execute"</span>,<span class="string">"Corrupted SubEvent, SubId %x"</span>,<a href="../HldEvent.html#HldEvent:subEvt" title="HldSubEvent HldEvent::subEvt">subEvt</a>[i].<a href="../HldEvent.html#HldEvent:getId" title="UInt4 HldEvent::getId()">getId</a>());          
      }

    } <span class="comment">//end loop subevts</span>
    
    <span class="comment">//wk added</span>
    <span class="keyword">if</span>(<a href="../HldEvent.html#HldEvent:pSubEvt" title="HldSubEvent* HldEvent::pSubEvt">pSubEvt</a>)
    {
	    <a href="../HldEvent.html#HldEvent:decode" title="Int_t HldEvent::decode()">decode</a>();
    }
    <span class="comment">//end wk added</span>
    <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kTRUE</a>;    
  } 
  <span class="keyword">else</span> 
    <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
  
}
  
<span class="comment">//______________________________________________________________________________</span>
<a name="uGUCtC"></a><a href="../ListOfTypes.html#Bool_t">Bool_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:swap" title="Bool_t HldEvent::swap()">swap</a>() {
<span class="comment">//only swapping correctly the header  </span>
  <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:read" title="Bool_t HldEvent::read()">read</a>()) {
   <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kTRUE</a>;
  } <span class="keyword">else</span> {
   <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
  }
}


<span class="comment">//from HldBase</span>
<span class="comment">//______________________________________________________________________________</span>
<a name="rYl7OE"></a><span class="keyword">void</span> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:swap2" title="void HldEvent::swap2(UShort_t* p,const size_t len)">swap2</a>(<a href="../ListOfTypes.html#UShort_t">UShort_t</a>* ptr, <span class="keyword">const</span> <a href="../ListOfTypes.html#size_t">size_t</a> len) <span class="keyword">const</span> {
    <span class="keyword">for</span> (<a href="../ListOfTypes.html#size_t">size_t</a> i = 0; i &lt; len; ++i) {
	    <a href="../ListOfTypes.html#UShort_t">UShort_t</a> tmp = ptr[i];
	    <a href="../ListOfTypes.html#UChar_t">UChar_t</a>* t = (<a href="../ListOfTypes.html#UChar_t">UChar_t</a>*) &amp;tmp;
	    <a href="../ListOfTypes.html#UChar_t">UChar_t</a>* p = (<a href="../ListOfTypes.html#UChar_t">UChar_t</a>*) &amp;ptr[i];
	    p[0] = t[1];
	    p[1] = t[0];
     }
}

<span class="comment">//______________________________________________________________________________</span>
<a name="OrEf3C"></a><span class="keyword">void</span> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:swap4" title="void HldEvent::swap4(UInt_t* p,const size_t len)">swap4</a>(<a href="../ListOfTypes.html#UInt4">UInt4</a>* p, <span class="keyword">const</span> <a href="../ListOfTypes.html#size_t">size_t</a> len) <span class="keyword">const</span> {
  <a href="../ListOfTypes.html#UInt4">UInt4</a> tmp;
  UInt1* d;
  UInt1* <span class="keyword">const</span> s = (UInt1*) &amp;tmp;
  <span class="keyword">for</span> (<a href="../ListOfTypes.html#size_t">size_t</a> i = 0; i &lt; len; i++) {
    d = (UInt1*) (p + i);
    tmp = p[i];
    d[0] = s[3];
    d[1] = s[2];
    d[2] = s[1];
    d[3] = s[0];
  }
}


<span class="comment">//end HldBase</span>

<span class="comment">//from HldEvt</span>
<span class="comment">//______________________________________________________________________________</span>
<a name="ECK8ZD"></a><a href="../ListOfTypes.html#Int_t">Int_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:appendSubEvtIdx" title="Int_t HldEvent::appendSubEvtIdx()">appendSubEvtIdx</a>() {
  <a href="../HldEvent.html#HldEvent:subEvtTable" title="HldEvent::SubEvtTable HldEvent::subEvtTable">subEvtTable</a>[<a href="../HldEvent.html#HldEvent:lastSubEvtIdx" title="size_t HldEvent::lastSubEvtIdx">lastSubEvtIdx</a>].id = <a href="../HldEvent.html#HldEvent:getSubEvtId" title="Int_t HldEvent::getSubEvtId()">getSubEvtId</a>();
  <a href="../HldEvent.html#HldEvent:subEvtTable" title="HldEvent::SubEvtTable HldEvent::subEvtTable">subEvtTable</a>[<a href="../HldEvent.html#HldEvent:lastSubEvtIdx" title="size_t HldEvent::lastSubEvtIdx">lastSubEvtIdx</a>].p = <a href="../HldEvent.html#HldEvent:getpSubEvt" title="HldEvent::HPP HldEvent::getpSubEvt()">getpSubEvt</a>();
  <span class="keyword">if</span> (<a href="../HldEvent.html#HldEvent:lastSubEvtIdx" title="size_t HldEvent::lastSubEvtIdx">lastSubEvtIdx</a> == <a href="../HldEvent.html#HldEvent:maxSubEvtIdx" title="const size_t HldEvent::maxSubEvtIdx">maxSubEvtIdx</a> - 1) {
  printf(<span class="string">"\nMax. nb of unpackers (%d) exceeded!\n\n"</span>,<a href="../HldEvent.html#HldEvent:maxSubEvtIdx" title="const size_t HldEvent::maxSubEvtIdx">maxSubEvtIdx</a>);
			      <span class="keyword">return</span> 0;
			        } <span class="keyword">else</span> <span class="keyword">return</span> ++<a href="../HldEvent.html#HldEvent:lastSubEvtIdx" title="size_t HldEvent::lastSubEvtIdx">lastSubEvtIdx</a>;
}

<span class="comment">//end HldEvt</span>


<span class="comment">//wk from testunpacker --unpacker classes</span>

<span class="comment">//______________________________________________________________________________</span>
<a name="mXwY9C"></a><span class="keyword">void</span> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:clearAll" title="void HldEvent::clearAll()">clearAll</a>(<span class="keyword">void</span>){
  <span class="keyword">for</span>(<a href="../ListOfTypes.html#Int_t">Int_t</a> i=0; i&lt;128; i++){
    <span class="keyword">for</span>(<a href="../ListOfTypes.html#Int_t">Int_t</a> k=0; k&lt;<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>; k++){
      <a href="../HldEvent.html#HldEvent:LeadingTime" title="Int_t HldEvent::LeadingTime">LeadingTime</a>[i][k]  = -1000000;
      <a href="../HldEvent.html#HldEvent:TrailingTime" title="Int_t HldEvent::TrailingTime">TrailingTime</a>[i][k] = -1000000;
      <a href="../HldEvent.html#HldEvent:trbADC" title="Int_t HldEvent::trbADC">trbADC</a>[i][k]=-1; 
    }    
    <a href="../HldEvent.html#HldEvent:LeadingMult" title="Int_t HldEvent::LeadingMult">LeadingMult</a>[i]=0;  
    <a href="../HldEvent.html#HldEvent:TrailingMult" title="Int_t HldEvent::TrailingMult">TrailingMult</a>[i]=0;  
  }
  <a href="../HldEvent.html#HldEvent:errors_per_event" title="Int_t HldEvent::errors_per_event">errors_per_event</a>=0;
}

<span class="comment">//______________________________________________________________________________</span>
<a name="wnLEAC"></a><a href="../ListOfTypes.html#Bool_t">Bool_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:fill_lead" title="Bool_t HldEvent::fill_lead(Int_t ch,Int_t d)">fill_lead</a>(<a href="../ListOfTypes.html#Int_t">Int_t</a> ch,<a href="../ListOfTypes.html#Int_t">Int_t</a> time)
{
	
<span class="comment">//wk added 02.02.07</span>
  <a href="../ListOfTypes.html#Int_t">Int_t</a> trailMult=<a href="../HldEvent.html#HldEvent:TrailingMult" title="Int_t HldEvent::TrailingMult">TrailingMult</a>[ch]; <span class="comment">//Trailing Multiplicity</span>
  <a href="../ListOfTypes.html#Int_t">Int_t</a> leadMult=<a href="../HldEvent.html#HldEvent:LeadingMult" title="Int_t HldEvent::LeadingMult">LeadingMult</a>[ch]; <span class="comment">//Leading Multiplicity</span>

  
  <a href="../HldEvent.html#HldEvent:LeadingMult" title="Int_t HldEvent::LeadingMult">LeadingMult</a>[ch]++;
 
  <span class="keyword">if</span>(leadMult&lt;<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>)
  {
    <span class="keyword">if</span>(leadMult&lt;=trailMult+1)
    {
      <a href="../HldEvent.html#HldEvent:LeadingTime" title="Int_t HldEvent::LeadingTime">LeadingTime</a>[ch][leadMult]=time;
    }
    <span class="keyword">else</span>
    {
      <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
    }
  }
  <span class="keyword">return</span>((leadMult+1)&lt;=<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>);
    
    
   <span class="comment">///////////////////////////////////////////</span>
   <span class="comment">// Stores the given time in the next data element</span>
   <span class="comment">// and sets the multiplicity.</span>
   <span class="comment">// Return <a href="../ListOfTypes.html#bool">false</a> if <a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a> hits are already stored.</span>
   <span class="comment">///////////////////////////////////////////</span>
  
<span class="comment">/*
   if( trbLeadingMult[ch]&lt;<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>){
      trbLeadingTime[ch][trbLeadingMult[ch]]=time;
   }
   //wk added
   <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt; <span class="string">"zwiekszamy multiplicity dla kanalu: "</span>&lt;&lt;ch&lt;&lt;endl;
   trbLeadingMult[ch]++;
   <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt; <span class="string">"multiplicity wynosi: "</span>&lt;&lt;trbLeadingMult[ch]&lt;&lt;endl;
   return(trbLeadingMult[ch]&lt;=<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>);
*/</span>
	
}

<span class="comment">//______________________________________________________________________________</span>
<a name="ALk.QC"></a><a href="../ListOfTypes.html#Bool_t">Bool_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:fill_trail" title="Bool_t HldEvent::fill_trail(Int_t ch,Int_t d)">fill_trail</a>(<a href="../ListOfTypes.html#Int_t">Int_t</a> ch,<a href="../ListOfTypes.html#Int_t">Int_t</a> time)
{
	
<span class="comment">//wk added 02.02.07</span>
  <a href="../ListOfTypes.html#Int_t">Int_t</a> trailMult=<a href="../HldEvent.html#HldEvent:TrailingMult" title="Int_t HldEvent::TrailingMult">TrailingMult</a>[ch]; <span class="comment">//Trailing Multiplicity</span>
  <a href="../ListOfTypes.html#Int_t">Int_t</a> leadMult=<a href="../HldEvent.html#HldEvent:LeadingMult" title="Int_t HldEvent::LeadingMult">LeadingMult</a>[ch]; <span class="comment">//Leading Multiplicity</span>
  
  <a href="../HldEvent.html#HldEvent:TrailingMult" title="Int_t HldEvent::TrailingMult">TrailingMult</a>[ch]++;
  
  <span class="keyword">if</span>(trailMult&lt;<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>)
  {
    <span class="keyword">if</span>(trailMult&lt;=leadMult+1)
    {
      <a href="../HldEvent.html#HldEvent:TrailingTime" title="Int_t HldEvent::TrailingTime">TrailingTime</a>[ch][trailMult]=time;
      <span class="comment">//ADC cannot be set here</span>
    }
    <span class="keyword">else</span>
    {
      <span class="keyword">return</span> <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
    }
  }

 <span class="keyword">return</span>((trailMult+1)&lt;=<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>);	
 
   <span class="comment">///////////////////////////////////////////</span>
   <span class="comment">// Calculates the time between trailing and LAST(!) leading hit.</span>
   <span class="comment">// No other check if its really the right one,</span>
   <span class="comment">// i am depending on the TDC to deliver the right order</span>
   <span class="comment">// Return <a href="../ListOfTypes.html#Bool_t">kFALSE</a> if no leading yet or more than <a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a> Hits</span>
   <span class="comment">///////////////////////////////////////////</span>
<span class="comment">/*
   <a href="../ListOfTypes.html#Int_t">Int_t</a> m;// Leading Multiplicity
   m=trbLeadingMult[ch];
   //wk added
   <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt; <span class="string">"multiplicity dla kanalu: "</span>&lt;&lt;ch&lt;&lt;<span class="string">"wynosi "</span>&lt;&lt;trbLeadingMult[ch]&lt;&lt;endl;
   if(m==0) {//wk added
	   <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;<span class="string">" jestem w fill_trail leading multiplicity =0"</span>&lt;&lt;endl;
	   return <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;
   }

   if( m&lt;=<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>){
      if( trbTrailingMult[ch]!=m){
         trbTrailingTime[ch][m-1]=time;
         <a href="../HldEvent.html#HldEvent:trbADC" title="Int_t HldEvent::trbADC">trbADC</a>[ch][m-1] = time - trbLeadingTime[ch][m-1];
      }else{ //wk added
         <a href="../ListOfTypes.html#ostream">cout</a> &lt;&lt;<span class="string">"Mamy juz to zbocze opadajace ??"</span>&lt;&lt;endl;
	 return <a href="../ListOfTypes.html#Bool_t">kFALSE</a>;// In this case we already have one trailing
      }
   }
   trbTrailingMult[ch]=m;

   return(trbTrailingMult[ch]&lt;=<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>);
*/</span>
	
}

<span class="comment">//______________________________________________________________________________</span>
<a name="UlKPa"></a><span class="keyword">void</span> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:PrintTdcError" title="void HldEvent::PrintTdcError(UInt_t e)">PrintTdcError</a>(<a href="../ListOfTypes.html#UInt_t">UInt_t</a> e)
{
   <a href="../ListOfTypes.html#Char_t">Char_t</a> *e_str[15]={
      <span class="string">"Hit lost in group 0 from read-out FIFO overflow"</span>,
      <span class="string">"Hit lost in group 0 from L1 buffer overflow"</span>,
      <span class="string">"Hit error have been detected in group 0"</span>,
      <span class="string">"Hit lost in group 1 from read-out FIFO overflow"</span>,
      <span class="string">"Hit lost in group 1 from L1 buffer overflow"</span>,
      <span class="string">"Hit error have been detected in group 1"</span>,
      <span class="string">"Hit lost in group 2 from read-out FIFO overflow"</span>,
      <span class="string">"Hit lost in group 2 from L1 buffer overflow"</span>,
      <span class="string">"Hit error have been detected in group 2"</span>,
      <span class="string">"Hit lost in group 3 from read-out FIFO overflow"</span>,
      <span class="string">"Hit lost in group 3 from L1 buffer overflow"</span>,
      <span class="string">"Hit error have been detected in group 3"</span>,
      <span class="string">"Hits rejected because of programmed event size limit"</span>,
      <span class="string">"Event lost (trigger FIFO overflow)"</span>,
      <span class="string">"Internal fatal chip error has been detected"</span>
   };

   <span class="keyword">if</span>(e==0) <span class="keyword">return</span>;<span class="comment">// No <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a></span>

   <a href="../ListOfTypes.html#ostream">cout</a> &lt;&lt; <span class="string">"=== TRB/TDC Error analysis:"</span> &lt;&lt; endl;
   <span class="keyword">for</span>(<a href="../ListOfTypes.html#Int_t">Int_t</a> i=0; i&lt;15; i++){
      <span class="keyword">if</span>( e&amp;0x1){
         <a href="../ListOfTypes.html#ostream">cout</a> &lt;&lt; e_str[i] &lt;&lt; endl;
      }
      e&gt;&gt;=1;
   }
   <a href="../ListOfTypes.html#ostream">cout</a> &lt;&lt; <span class="string">"==="</span> &lt;&lt; endl;
}

<span class="comment">//______________________________________________________________________________</span>
<a name="DZQvbD"></a><a href="../ListOfTypes.html#Int_t">Int_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:decode" title="Int_t HldEvent::decode()">decode</a>(<span class="keyword">void</span>)
{
   <a href="../HldEvent.html#HldEvent:clearAll" title="void HldEvent::clearAll()">clearAll</a>();

<span class="comment">/*   <a href="../ListOfTypes.html#UInt_t">UInt_t</a> nEvt        = 0;   //Evt SeqNumber
   <a href="../ListOfTypes.html#Int_t">Int_t</a> nEvId       = 0;    //Evt Id */</span>

   <a href="../ListOfTypes.html#Int_t">Int_t</a> TdcId;
   <a href="../ListOfTypes.html#Int_t">Int_t</a> nCountTDC = 0;
<span class="comment">//   <a href="../ListOfTypes.html#Int_t">Int_t</a> nCountTDCHeader = 0;</span>
<span class="comment">//   <a href="../ListOfTypes.html#Int_t">Int_t</a> nCountTDCTrailer = 0;</span>

   <a href="../ListOfTypes.html#UInt_t">UInt_t</a> nEvtNr;

   <a href="../ListOfTypes.html#UInt_t">UInt_t</a> nSizeCounter = 0;
   <a href="../ListOfTypes.html#UInt_t">UInt_t</a> nTdcEvtId = 0;
<span class="comment">//   <a href="../ListOfTypes.html#Int_t">Int_t</a> nTdcBunchId = -1;</span>
   <a href="../ListOfTypes.html#UInt_t">UInt_t</a> TdcDataLen=0;

   <a href="../ListOfTypes.html#UInt_t">UInt_t</a> uBlockSize=0;

<span class="comment">//wk <a href="../HldEvent.html#HldEvent:getData" title="UInt4* HldEvent::getData()">getData</a> z hldbase.h</span>
   <a href="../ListOfTypes.html#UInt_t">UInt_t</a>* data = <a href="../HldEvent.html#HldEvent:pSubEvt" title="HldSubEvent* HldEvent::pSubEvt">pSubEvt</a>-><a href="../HldSubEvent.html#HldSubEvent:getData" title="UInt4* HldSubEvent::getData()">getData</a>();
   <a href="../ListOfTypes.html#UInt_t">UInt_t</a>* end  = <a href="../HldEvent.html#HldEvent:pSubEvt" title="HldSubEvent* HldEvent::pSubEvt">pSubEvt</a>-><a href="../HldSubEvent.html#HldSubEvent:getEnd" title="UInt4* HldSubEvent::getEnd()">getEnd</a>();
 
<span class="comment">//wk tutaj jest sedno</span>
<span class="comment">/*wk  nEvt = gHades-&gt;getCurrentEvent()-&gt;<a href="../HldEvent.html#HldEvent:getHeader" title="UInt4* HldEvent::getHeader()">getHeader</a>()-&gt;getEventSeqNumber();

   //////////////////////////////////////////////////////////
   //   <a href="../HldEvent.html#HldEvent:debugFlag1" title="Int_t HldEvent::debugFlag1">debugFlag1</a> is used only                            //
   // for special cases                                    //
   // if set to 1:                                         //
   // actual EVENT ID is overwritten                       //
   // by value 1, that means event will be treated as      //
   // normal data                                          //
   //////////////////////////////////////////////////////////
   if(<a href="../HldEvent.html#HldEvent:debugFlag1" title="Int_t HldEvent::debugFlag1">debugFlag1</a> &gt; 0){
      gHades-&gt;getCurrentEvent()-&gt;<a href="../HldEvent.html#HldEvent:getHeader" title="UInt4* HldEvent::getHeader()">getHeader</a>()-&gt;setId(1);
   }
   nEvId = gHades-&gt;getCurrentEvent()-&gt;<a href="../HldEvent.html#HldEvent:getHeader" title="UInt4* HldEvent::getHeader()">getHeader</a>()-&gt;<a href="../HldEvent.html#HldEvent:getId" title="UInt4 HldEvent::getId()">getId</a>();

   if((<a href="../HldEvent.html#HldEvent:debugFlag" title="Int_t HldEvent::debugFlag">debugFlag</a> &gt; 0 )&amp;&amp; (!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)){
      <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;endl;
      <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;<span class="string">"--TRB SubEvent: EvtNb= "</span>&lt;&lt;nEvt&lt;&lt;<span class="string">" --- Evnt Id= "</span>&lt;&lt;nEvId&lt;&lt;endl;
      <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;<span class="string">"--debugFlag = "</span>&lt;&lt;<a href="../HldEvent.html#HldEvent:debugFlag" title="Int_t HldEvent::debugFlag">debugFlag</a>&lt;&lt;endl;
      <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;<span class="string">"--debugFlag1 = "</span>&lt;&lt;<a href="../HldEvent.html#HldEvent:debugFlag1" title="Int_t HldEvent::debugFlag1">debugFlag1</a>&lt;&lt;endl;
      <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;<span class="string">"--quietMode = "</span>&lt;&lt;<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>&lt;&lt;endl;
      if(<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>==0) <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;<span class="string">"--quietMode0 = "</span>&lt;&lt;<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>&lt;&lt;endl;
      if(<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>&gt;0) <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;<span class="string">"--quietMode1 = "</span>&lt;&lt;<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>&lt;&lt;endl;
      //Loop over all data in this subevt

      <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;hex&lt;&lt;<span class="string">"data word: "</span>&lt;&lt;*data&lt;&lt;dec&lt;&lt;endl;
      <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt;hex&lt;&lt;<span class="string">"data word: ---SUBEVENT HEADER: "</span>&lt;&lt;*data&lt;&lt;dec&lt;&lt;endl;
   }
*/</span>
   <span class="comment">// first word in subevent contains info about subevent size 0xbeef_6a_20 (magic,EvtId,length)</span>
   <span class="comment">// should be used for checking the subevent.</span>

   <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
   <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"=== Unpacker start SubEvtId: %d\n===Header: %X  Nr:%d  Len:%d\n"</span>,<a href="../HldEvent.html#HldEvent:subEvtId" title="UInt_t HldEvent::subEvtId">subEvtId</a>,*data&gt;&gt;16,nEvtNr,uBlockSize);
   <span class="cpp">#endif</span>

   <span class="keyword">if</span>((*data&amp;0xFFFF0000)==0xBE010000){
   <span class="comment">//wk   if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TRB Buffer overflow, Data truncated. No lethal error, but please report if error is persistend!!!"</span>);</span>
      <span class="keyword">return</span>(<a href="../ListOfTypes.html#Bool_t">kFALSE</a>);
   }

   <span class="comment">// BEEF has been replaced ny BE00 before the Beamtime, I only need it for</span>
   <span class="comment">// analysis of test files ... remove after Beamtime</span>
   <span class="keyword">if</span>((*data&amp;0xFFFF0000)!=0xBEEF0000 &amp;&amp; (*data&amp;0xFFFF0000)!=0xBE000000){
    <span class="comment">//wk  if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"NO $BEEF FOUND!!!"</span>);</span>
<span class="comment">//      exit();</span>
   }
   uBlockSize=*data&amp;0xFF;
   nEvtNr=(*data&gt;&gt;8)&amp;0xFF;

   <span class="keyword">if</span>(nEvtNr!=(<a href="../ListOfTypes.html#UInt_t">UInt_t</a>)<a href="../HldEvent.html#HldEvent:pSubEvt" title="HldSubEvent* HldEvent::pSubEvt">pSubEvt</a>-><a href="../HldSubEvent.html#HldSubEvent:getTrigNr" title="int HldSubEvent::getTrigNr()">getTrigNr</a>()){
<span class="comment">/*wk       if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>){
	   <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TRB EvtNr!=pSubEvt-&gt;getTrigNr() ********* Event Mixing *********"</span>);
	   printf(<span class="string">"=== %d != %d \n"</span>,nEvtNr,(<a href="../ListOfTypes.html#UInt_t">UInt_t</a>)<a href="../HldEvent.html#HldEvent:pSubEvt" title="HldSubEvent* HldEvent::pSubEvt">pSubEvt</a>-><a href="../HldSubEvent.html#HldSubEvent:getTrigNr" title="int HldSubEvent::getTrigNr()">getTrigNr</a>());
       }
       */</span>
      <span class="keyword">return</span>(<a href="../ListOfTypes.html#Bool_t">kFALSE</a>);
   }

<span class="comment">//   if(uBlockSize&lt;10){</span>
<span class="cpp">#warning "Change value to 10 if all TRBs have 4 TDCs after beamtime may06"</span>
   <span class="keyword">if</span>(uBlockSize&lt;8){
      <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"Error in TRB unpack: Suspicious length (too small for header/trailer of tdcs) %d , might be a overflow!\n"</span>,uBlockSize);
   }

   nSizeCounter++;<span class="comment">// First one already processed</span>

   <span class="keyword">while</span> ( ++data&lt;end &amp;&amp; *data!=0x0 )
   {
      <a href="../ListOfTypes.html#UInt_t">UInt_t</a> dataword;
      dataword=*data;<span class="comment">//[ii];</span>

      nSizeCounter++;

      <span class="keyword">if</span>(dataword==0xDEADFACE){
         <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
         <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: Found DEADFACE -&gt; break %08X %08X\n"</span>,data,end);
         <span class="cpp">#endif</span>
         <span class="keyword">break</span>;
      }

      TdcId=(dataword&gt;&gt;24)&amp;0xF;<span class="comment">// might be wrong for TRB board</span>
      TdcId=nCountTDC;


      <span class="keyword">if</span>(TdcDataLen&gt;0) TdcDataLen++;

      <span class="keyword">switch</span>(dataword&gt;&gt;28){<span class="comment">// Raw TDC Data</span>
         <span class="keyword">case</span> 0:{<span class="comment">// Group Header</span>
            <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: Found GLOBAL Header $%08X\n"</span>,dataword);
            <span class="cpp">#endif</span>
<span class="comment">/*wk
            if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Info" title="void TObject::Info(const char* method,const char* msgfmt)">Info</a>(<span class="string">"TRB unpack"</span>,<span class="string">"Global Header not expected!"</span>);
            break;
         }
         case 1:{// Group Trailer
            #if DEBUG_LEVEL&gt;4
            if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: Found GLOBAL Trailer $%08X\n"</span>,dataword);
            #endif

            if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Info" title="void TObject::Info(const char* method,const char* msgfmt)">Info</a>(<span class="string">"TRB unpack"</span>,<span class="string">"Global Trailer not expected!"</span>);
            break;
*/</span>
         }
         <span class="keyword">case</span> 2:{<span class="comment">// TDC Header</span>
            <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: Found TDC %d Header $%04X $%04X\n"</span>,TdcId,(dataword&gt;&gt;12)&amp;0xFFF,dataword&amp;0xFFF);
            <span class="cpp">#endif</span>

            <span class="keyword">if</span>( nCountTDC&gt;0 &amp;&amp; nTdcEvtId!=((dataword&gt;&gt;12)&amp;0xFFF)){
           <span class="comment">//wk    if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TDCs have different EventIds ******* Event Mixing *******"</span>);</span>
               <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"nTdcEvtId: %06X   dataword:  %06X  nEvtNr: %02X\n"</span> , nTdcEvtId ,((dataword&gt;&gt;12)&amp;0xFFF),nEvtNr);
<span class="comment">//               exit();</span>
<span class="comment">//               return(<a href="../ListOfTypes.html#Bool_t">kFALSE</a>);</span>
            }
            <span class="keyword">if</span>( nEvtNr!=((dataword&gt;&gt;12)&amp;0xFF)){
           <span class="comment">//wk    if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TDC EventIds != Main EventId ******* Event Mixing *******"</span>);</span>
               <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"nTdcEvtId: %06X   dataword:  %06X  nEvtNr: %02X\n"</span> , nTdcEvtId ,((dataword&gt;&gt;12)&amp;0xFFF),nEvtNr);
<span class="comment">//               exit();</span>
<span class="comment">//               return(<a href="../ListOfTypes.html#Bool_t">kFALSE</a>);</span>
            }
            <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"nTdcEvtId: %06X   dataword:  %06X  nEvtNr: %02X\n"</span> , nTdcEvtId ,((dataword&gt;&gt;12)&amp;0xFFF),nEvtNr);
            <span class="cpp">#endif</span>
            nTdcEvtId=(dataword&gt;&gt;12)&amp;0xFFF;

            TdcDataLen=1;
            <span class="keyword">break</span>;
         }
         <span class="keyword">case</span> 3:{<span class="comment">// TDC Trailer</span>
            <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: Found TDC %d Trailer $%04X $%04X\n"</span>,TdcId,(dataword&gt;&gt;12)&amp;0xFFF,dataword&amp;0xFFF);
            <span class="cpp">#endif</span>
            <span class="keyword">if</span>(TdcDataLen!=(dataword&amp;0xFFF)){
          <span class="comment">//wk     if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TdcDataLen!= length in Trailer!"</span>);</span>
               <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: TdcDataLen %d != %d "</span>,TdcDataLen,dataword&amp;0xFFF);
            }
            TdcDataLen=0;
            <span class="keyword">if</span>( nTdcEvtId!=((dataword&gt;&gt;12)&amp;0xFFF)){
       <span class="comment">//wk        if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TDC Header and Trailer have different EventIds"</span>);</span>
<span class="comment">//               exit();</span>
<span class="comment">//               return(<a href="../ListOfTypes.html#Bool_t">kFALSE</a>);</span>
            }
            nCountTDC++;
            <span class="keyword">break</span>;
         }
         <span class="keyword">case</span> 4:{<span class="comment">// TDC DATA Leading</span>
           
	    <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: Found TDC %d Lead Data $%08X\n"</span>,TdcId,dataword);
            <span class="cpp">#endif</span>
            <a href="../ListOfTypes.html#Int_t">Int_t</a> nData, nChannel;
            nChannel=(dataword&gt;&gt;19)&amp;0x1f; <span class="comment">// <a href="../HldEvent.html#HldEvent:decode" title="Int_t HldEvent::decode()">decode</a> channel</span>
            nChannel+=TdcId*32;
            nData=dataword&amp;0x7ffff;   <span class="comment">// <a href="../HldEvent.html#HldEvent:decode" title="Int_t HldEvent::decode()">decode</a> 19bit data</span>
            <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"(Chan,Data) %3d, %d\n"</span>,nChannel,nData);
            <span class="cpp">#endif</span>

            <span class="comment">// this is for SINGLE LEADING/TRAILING EDGE measurements only!!!</span>
            <span class="comment">//wk added wypelniane lead</span>
	    <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:fill_lead" title="Bool_t HldEvent::fill_lead(Int_t ch,Int_t d)">fill_lead</a>(nChannel,nData)){
            <span class="comment">//   <a href="../ListOfTypes.html#ostream">cout</a>&lt;&lt; <span class="string">"Leading without Trailing or Too many Hits"</span>&lt;&lt;endl;</span>
            }
	    <span class="keyword">break</span>;
         }
         <span class="keyword">case</span> 5:{<span class="comment">// TDC DATA Trailing</span>
            <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: Found TDC %d Trail Data $%08X\n"</span>,TdcId,dataword);
            <span class="cpp">#endif</span>
            <a href="../ListOfTypes.html#Int_t">Int_t</a> nData, nChannel;
            nChannel=(dataword&gt;&gt;19)&amp;0x1f; <span class="comment">// <a href="../HldEvent.html#HldEvent:decode" title="Int_t HldEvent::decode()">decode</a> channel</span>
            nChannel+=TdcId*32;
            nData=dataword&amp;0x7ffff;   <span class="comment">// <a href="../HldEvent.html#HldEvent:decode" title="Int_t HldEvent::decode()">decode</a> 19bit data</span>
            <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"(Chan,Data) %3d, %d\n"</span>,nChannel,nData);
            <span class="cpp">#endif</span>
            <span class="comment">// this is for SINGLE LEADING/TRAILING EDGE measurements only!!!</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:fill_trail" title="Bool_t HldEvent::fill_trail(Int_t ch,Int_t d)">fill_trail</a>(nChannel,nData)){
             
	<span class="comment">//	<a href="../ListOfTypes.html#ostream">cout</a> &lt;&lt;<span class="string">"Trailing without Leading or Too many Hits"</span>&lt;&lt;endl;</span>
            }
            <span class="keyword">break</span>;
         }
         <span class="keyword">case</span> 6:{<span class="comment">// TDC ERROR</span>
	    <a href="../HldEvent.html#HldEvent:incErrorNr" title="void HldEvent::incErrorNr()">incErrorNr</a>();
            <span class="keyword">if</span>((dataword&amp;0x7FFF)==0x1000){<span class="comment">// special case for non fatal errors</span>
          <span class="comment">//wk     if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Info" title="void TObject::Info(const char* method,const char* msgfmt)">Info</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TDC Event Size Limit exceeded!\n"</span>);</span>
               <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"(TDC %d Error Event Size Limit: $%08X)\n"</span>,TdcId,dataword);
            }<span class="keyword">else</span>{
          <span class="comment">//wk     if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Info" title="void TObject::Info(const char* method,const char* msgfmt)">Info</a>(<span class="string">"TRB unpack"</span>,<span class="string">"Found TDC Error(s)!\n"</span>);</span>
               <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TDC %d Error $%04X ($%08X)\n"</span>,TdcId,dataword&amp;0x7FFF,dataword);
               <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="../HldEvent.html#HldEvent:PrintTdcError" title="void HldEvent::PrintTdcError(UInt_t e)">PrintTdcError</a>(dataword&amp;0x7FFF);
            }
            <span class="keyword">break</span>;
         }
         <span class="keyword">case</span> 7:{<span class="comment">// Debug <a href="http://root.cern.ch/root/html/TObject.html#TObject:Info" title="void TObject::Info(const char* method,const char* msgfmt)">Info</a></span>
      <span class="comment">//wk      if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"Found DEBUG Info"</span>);</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: TDC %d: Found Debug Info $%08X"</span>,TdcId,dataword);
            <span class="keyword">break</span>;
         }
         <span class="keyword">default</span>:{<span class="comment">// not defined!</span>
     <span class="comment">//wk       if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"Found UNDEFINED data"</span>);</span>
            <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"TRB unpack: TDC %d: Found undefined $%08X"</span>,TdcId,dataword);
            <span class="keyword">break</span>;
         }
      }
   }

   <span class="keyword">if</span>(nCountTDC!=4){
      <span class="keyword">if</span>( nCountTDC&lt;4){
<span class="cpp">#warning "Comment this in after may06 beamtime"</span>
<span class="comment">//         <a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TDC count &lt;4 -&gt; TDC data missing!!!"</span>);</span>
      }<span class="keyword">else</span>{
     <span class="comment">//wk    if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"TDC count &gt;4 -&gt; additional TDC data!!!"</span>);</span>
      }
   }

   <span class="keyword">if</span>(uBlockSize!=nSizeCounter){
   <span class="comment">//wk   if(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)<a href="http://root.cern.ch/root/html/TObject.html#TObject:Error" title="void TObject::Error(const char* method,const char* msgfmt)">Error</a>(<span class="string">"TRB unpack"</span>,<span class="string">"Blocksize!=Counted words!!!"</span>);</span>
   }
   <span class="cpp">#if DEBUG_LEVEL&gt;4</span>
   <span class="keyword">if</span>(!<a href="../HldEvent.html#HldEvent:quietMode" title="Bool_t HldEvent::quietMode">quietMode</a>)printf(<span class="string">"==== Unpacker end (%d)\n"</span>,<a href="../HldEvent.html#HldEvent:subEvtId" title="UInt_t HldEvent::subEvtId">subEvtId</a>);
   <span class="cpp">#endif</span>

   <span class="keyword">return</span>(<a href="../ListOfTypes.html#Bool_t">kTRUE</a>);
}


<span class="comment">//wk from HldUnpack</span>
<span class="comment">//______________________________________________________________________________</span>
<a href="../HldEvent.html">HldEvent</a>::HPP <span class="keyword">const</span> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:getpSubEvt" title="HldEvent::HPP HldEvent::getpSubEvt()">getpSubEvt</a>(<span class="keyword">void</span>) {
  <span class="comment">//Return a pointer to the subevent <a href="../HldEvent.html#HldEvent:read" title="Bool_t HldEvent::read()">read</a> by this unpacker</span>
  <span class="keyword">return</span> &amp;<a href="../HldEvent.html#HldEvent:pSubEvt" title="HldSubEvent* HldEvent::pSubEvt">pSubEvt</a>;
}

<span class="comment">/*wk <a href="../ListOfTypes.html#void">void</a> TestHldEvent::setCategory(HCategory *aCat) {
  //Sets the category where the unpacked data go to.
  pRawCat=aCat;
} 
*/</span>
<span class="comment">//end from HldUnpack</span>


<span class="comment">//end from testunpacker</span>

<span class="comment">//wk added 04.02.07</span>
<a name="hQUcKE"></a><a href="../ListOfTypes.html#Int_t">Int_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:getLeadingTime" title="Int_t HldEvent::getLeadingTime(Int_t channel,Int_t mult)">getLeadingTime</a>(<a href="../ListOfTypes.html#Int_t">Int_t</a> channel,<a href="../ListOfTypes.html#Int_t">Int_t</a> mult) <span class="keyword">const</span>
<span class="comment">//______________________________________________________________________________</span>
{

<span class="keyword">if</span>((channel&lt;<a href="../HldEvent.html#HldEvent:kMaxChannelNr" title="const Int_t HldEvent::kMaxChannelNr">kMaxChannelNr</a>) &amp;&amp; (mult&lt;<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>))
   <span class="keyword">return</span> <a href="../HldEvent.html#HldEvent:LeadingTime" title="Int_t HldEvent::LeadingTime">LeadingTime</a>[channel][mult];
<span class="keyword">return</span> -1; <span class="comment">//channel or multiplicity out of range</span>
}


<a name="UOlEzC"></a><a href="../ListOfTypes.html#Int_t">Int_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:getTrailingTime" title="Int_t HldEvent::getTrailingTime(Int_t channel,Int_t mult)">getTrailingTime</a>(<a href="../ListOfTypes.html#Int_t">Int_t</a> channel,<a href="../ListOfTypes.html#Int_t">Int_t</a> mult) <span class="keyword">const</span> 
<span class="comment">//______________________________________________________________________________</span>
{

<span class="keyword">if</span>((channel&lt;<a href="../HldEvent.html#HldEvent:kMaxChannelNr" title="const Int_t HldEvent::kMaxChannelNr">kMaxChannelNr</a>) &amp;&amp; (mult&lt;<a href="../HldEvent.html#HldEvent:kMaxMult" title="const Int_t HldEvent::kMaxMult">kMaxMult</a>))
   <span class="keyword">return</span> <a href="../HldEvent.html#HldEvent:TrailingTime" title="Int_t HldEvent::TrailingTime">TrailingTime</a>[channel][mult];
<span class="keyword">return</span> -1; <span class="comment">//channel or multiplicity out of range</span>
}


<a name="TYXTeC"></a><a href="../ListOfTypes.html#Int_t">Int_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:getLeadingMult" title="Int_t HldEvent::getLeadingMult(Int_t channel)">getLeadingMult</a>(<a href="../ListOfTypes.html#Int_t">Int_t</a> channel) <span class="keyword">const</span>
<span class="comment">//______________________________________________________________________________</span>
{

<span class="keyword">if</span>(channel&lt;<a href="../HldEvent.html#HldEvent:kMaxChannelNr" title="const Int_t HldEvent::kMaxChannelNr">kMaxChannelNr</a>) 
   <span class="keyword">return</span> <a href="../HldEvent.html#HldEvent:LeadingMult" title="Int_t HldEvent::LeadingMult">LeadingMult</a>[channel];
<span class="keyword">return</span> -1; <span class="comment">//channel out of range</span>
}

<a name="i9W5mC"></a><a href="../ListOfTypes.html#Int_t">Int_t</a> <a href="../HldEvent.html">HldEvent</a>::<a href="../HldEvent.html#HldEvent:getTrailingMult" title="Int_t HldEvent::getTrailingMult(Int_t channel)">getTrailingMult</a>(<a href="../ListOfTypes.html#Int_t">Int_t</a> channel) <span class="keyword">const</span>
<span class="comment">//______________________________________________________________________________</span>
{

<span class="keyword">if</span>(channel&lt;<a href="../HldEvent.html#HldEvent:kMaxChannelNr" title="const Int_t HldEvent::kMaxChannelNr">kMaxChannelNr</a>)
   <span class="keyword">return</span> <a href="../HldEvent.html#HldEvent:TrailingMult" title="Int_t HldEvent::TrailingMult">TrailingMult</a>[channel];
<span class="keyword">return</span> -1; <span class="comment">//channel out of range</span>
}
<span class="comment">//end </span>

</pre>

<br />
<!--SIGNATURE-->



<hr />
<em>
This page has been automatically generated. If you have any comments or suggestions about the page layout send a mail to <a href="mailto:rootdev@root.cern.ch">ROOT support</a>, or contact <a href="mailto:rootdev@root.cern.ch">the developers</a> with any questions or problems regarding ROOT.
</em>
</body>
</html>
